name: ChunabLive Bot

on:
    schedule:
        - cron: '15 * * * *'
    workflow_dispatch:

permissions:
    contents: write

concurrency:
    group: chunablive-bot
    cancel-in-progress: true

jobs:
    run:
        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
              node-version: '20.x'
              cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run ChunabLive bot
              env:
                  TARGET_URL: ${{ secrets.TARGET_URL }}
                  FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
                  FB_PAGE_ACCESS_TOKEN: ${{ secrets.FB_PAGE_ACCESS_TOKEN }}
              run: node index.js

            - name: Commit state.json if changed
              run: |
                  git config user.name "github-actions"
                  git config user.email "github-actions@github.com"

                  git add state.json

                  if git diff --cached --quiet; then
                    echo "No changes to commit"
                    exit 0
                  fi

                  git commit -m "Update state [skip ci]"
                  git push
